# agent:declare
version: 1
merge_strategy:
  precedence:
    - "root"
    - "home"
    - "subdir"
  arrays: "append"
  maps: "deep-merge"
project:
  name: "zimusyoku"
style:
  python:
    formatter:
      tool: "black"
      cmd: "black ."
      version: "24.8"
    lint:
      tool: "ruff"
      cmd: "ruff check ."
      fail_on:
        - "E"
        - "F"
qa:
  python:
    test_cmd: "pytest -q"
    coverage_cmd: "pytest --cov=src --cov-report=xml:reports/coverage.xml --junitxml=reports/junit.xml"
    coverage_threshold: 0.80
    artifacts:
      junit_xml: "reports/junit.xml"
      coverage_file: "reports/coverage.xml"
docs:
  must_update_when:
    - code_paths:
        - "src/**"
      docs_paths:
        - "README.md"
generated:
  python: null
  ts: null
  regenerate_cmds: []
adr:
  required_when: []
  path: "docs/adr"
  template: "docs/adr/TEMPLATE.md"
vcs:
  commits:
    convention: "conventional-commits"
  pr:
    template_required: true
    template:
      title: "[{type}] {scope}: {summary}"
      body_sections:
        - "変更概要"
        - "テスト結果（コマンド・スクリーンショット）"
        - "影響範囲（互換性・移行手順）"
        - "関連Issue/ADR"
    auto_assign:
      reviewers:
        rules: []
    checks_required:
      - "lint"
      - "unit"
      - "coverage>=0.80"
      - "docs-updated"
secrets:
  policy:
    prefer: "env"
    env_file: ".env"
    required: []
  redaction:
    patterns:
      - "apikey"
      - "token"
      - "password"
      - "secret"
      - "Bearer\\s+[A-Za-z0-9._-]+"
agent:
  bootstrap:
    read_files:
      - "AGENTS.md"
      - "README.md"
    merge_rules: "respect merge_strategy"
  must_run:
    - "style.python.formatter"
    - "style.python.lint"
    - "qa.python.test_cmd"
  must_block_on_failure:
    - "lint"
    - "coverage"
    - "checks_required"
  outputs:
    pr_format: "vcs.pr.template"
    junit_path: "qa.artifacts.junit_xml"
    coverage_path: "qa.artifacts.coverage_file"

# Repository Guidelines

## Project Structure & Module Organization
- `services/extractor`: Python ingestion and normalization service; tests live in `services/extractor/tests`.
- `web/console`: React/TypeScript console app; component specs sit in `web/console/src/**/__tests__`.
- `docs`: Sphinx sources plus ADR catalog; update `docs/SCHEMAS.md` when editing `src/**/schemas/*.yaml`.
- `reports`: Local staging for `reports/junit.xml` and `reports/coverage.xml`; keep artifacts out of Git.

## Build, Test, and Development Commands
- `make setup`: Install Python tooling, JS dependencies, and pre-commit hooks.
- `make build`: Compile extractor wheels and bundle the console.
- `npm --prefix web/console run dev`: Launch the console dev server with hot reload.
- `docker compose up --build -d`: Bring up extractor + console stack for integrated smoke checks.

## Coding Style & Naming Conventions
- Standardize on LF endings, two-space indentation, and kebab-case filenames across packages.
- Python: format via `black .` (24.8) and lint with `ruff check .`; pre-commit runs both plus `black --check .`.
- TypeScript: run `npm run fmt` (Prettier) and `npm run lint` (ESLint; config in `web/console/.eslintrc.cjs`); console overrides live in `web/console/AGENTS.md`.
- Secrets stay in `.env` for local use, but prefer the secret manager for shared credentials.

## Testing Guidelines
- Python: `pytest -q` for unit suites; keep `pytest --cov=src --cov-report=term-missing` >= 80% coverage.
- TypeScript: `npm --prefix web/console test -- --ci` with console coverage >= 85%; rerun flaky suites once when marked `flaky` or `network`.
- Clear caches (`.pytest_cache`, `node_modules/.cache`) if runs diverge before re-invoking tests.
- Publish CI artifacts to `reports/` on pipelines; avoid committing generated files locally.

## Commit & Pull Request Guidelines
- Follow Conventional Commits (e.g., `feat(extract): add table detector`, `fix(validate): handle zero tax invoices`).
- Populate the PR template: summary, validation, rollout risks, and linked issues/ADRs; attach UI screenshots when console views change.
- Autogenerated reviewers map to touched paths, so double-check assignments before requesting review.
- Merge only after `lint`, `unit`, `coverage>=0.80`, and `docs-updated` checks succeed; run `make docs` when API or schema contracts change.

## Documentation & Architecture Notes
- Regenerate docs with `make docs` after altering public APIs or schema files; Typedoc output ships alongside Sphinx.
- Capture design-impacting decisions under `docs/adr/` using the template; note rationale and follow-up tasks.
